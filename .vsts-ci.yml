# Build environment:
# https://docs.microsoft.com/en-us/vsts/build-release/concepts/definitions/build/variables?tabs=batch

steps:
- bash: docker -v
  displayName: Check docker version
  
- bash: mkdir -pv ./gopath/src/github.com/mweagle/helloworld
  displayName: Initialize source directory

- bash: |
    for EACHFILE in $(ls .);
    do if [ $EACHFILE != "gopath" ];
      then mv -v $EACHFILE ./gopath/src/github.com/mweagle/helloworld/$EACHFILE;
    fi;
    done
  displayName: Move source

- bash: curl -L -O https://dl.google.com/go/go1.9.2.linux-amd64.tar.gz
  displayName: Download Go

- bash: tar -xzf go1.9.2.linux-amd64.tar.gz -C $BUILD_SOURCESDIRECTORY
  displayName: Expand Go

- bash: which make
  continueOnError: true
  displayName: Which Make

- bash: $BUILD_SOURCESDIRECTORY/go/bin/go test -v .
  workingDirectory: $(Build.SourcesDirectory)/gopath/src/github.com/mweagle/helloworld
  env:
    GOPATH: $(Build.SourcesDirectory)/gopath
    GOROOT: $(Build.SourcesDirectory)/go
  displayName: Unit Test

- bash: $BUILD_SOURCESDIRECTORY/go/bin/go build -v .
  workingDirectory: $(Build.SourcesDirectory)/gopath/src/github.com/mweagle/helloworld
  env:
    GOPATH: $(Build.SourcesDirectory)/gopath
    GOROOT: $(Build.SourcesDirectory)/go
  displayName: Build

- task: publishBuildArtifacts@1
  displayName: Publish Artifacts
  inputs:
    PathtoPublish: $(Build.SourcesDirectory)/gopath/src/github.com/mweagle/helloworld
    ArtifactName: helloworld
    ArtifactType: Container
